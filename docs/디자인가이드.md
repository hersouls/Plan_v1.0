*최종 업데이트: 2025년 1월*

---

## 12. 백엔드 아키텍처 가이드 (Firebase Functions)

### 12.1 개요
- 백엔드 런타임: Firebase Cloud Functions (Node.js 20)
- 관리 대상: 할일(Task) 관련 이벤트 처리, 알림(Notification), 그룹/사용자 통계 집계, 주기적 리마인더 및 요약 전송
- 소스 위치: `functions/src/index.ts`

### 12.2 이벤트 트리거 요약
- onTaskCreated: `tasks/{taskId}` 문서 생성 시 작업 할당 알림, 그룹 통계 갱신, 활동 로그 생성
- onTaskUpdated: `tasks/{taskId}` 문서 업데이트 시 완료 처리, 재할당 알림, 그룹 통계 갱신
- onCommentCreated: `comments` 문서 생성 시 과제 참여자에게 댓글 알림, 댓글 수 갱신
- onCommentDeleted: `comments` 문서 삭제 시 과제의 댓글 수 갱신
- sendDailyReminders (스케줄): 매일 09:00, 마감 임박/지남 할일 알림 발송
- sendWeeklySummary (스케줄): 매주 일요일 18:00, 그룹 구성원별 주간 요약 발송

### 12.3 데이터 경로 및 규칙 의존성
- 주요 컬렉션: `tasks`, `comments`, `users`, `groups`, `activities`
- Functions는 Firestore/Storage 보안 규칙과 호환되도록 설계되었으며, 클라이언트 권한이 아닌 관리자(Admin SDK) 권한으로 실행됩니다.

### 12.4 알림(FCM) 정책
- 사용자 문서(`users/{userId}`)의 `fcmTokens: string[]`를 통해 멀티캐스트 발송
- 알림 data 페이로드에 `type`, `taskId`, `url` 등을 포함하여 클라이언트 라우팅과 UX 연계

### 12.5 스케줄 작업(CRON)
- 일일 리마인더: `0 9 * * *`
- 주간 요약: `0 18 * * 0`

### 12.6 배포
- Functions 단독 배포: `npm run firebase:deploy:functions`
- 전체(파이어스토어 룰/인덱스/스토리지 포함): `npm run firebase:deploy`

---

## 13. Firebase Firestore 설계 및 보안 규칙

### 13.1 주요 컬렉션 및 문서 모델
- users/{userId}: 사용자 프로필, 개인정보 공개 설정(privacy), fcmTokens, stats
- users/{userId}/settings: 사용자 설정 서브컬렉션
- groups/{groupId}: 그룹 소유자, 멤버 정책, 통계 필드(totalTasks, completionRate 등)
- groups/{groupId}/members/{memberId}: 그룹 멤버십 관리
- groups/{groupId}/chat/{messageId}: 그룹 채팅 메시지
- tasks/{taskId}: 개인/그룹 할일, 담당자, 상태, 마감일 등
- comments: 태스크 댓글(태스크 단위로 쿼리)
- notifications/{notificationId}: 사용자별 알림 저장
- activities/{activityId}: 활동 로그(읽기 전용)
- statistics/{userId}: 개인 통계(공개 옵션 지원)
- invites/{inviteId}: 그룹 초대 관리
- pointHistory / pointRules / pointStats: 포인트 시스템 관련 컬렉션

### 13.2 Firestore 보안 규칙 (실제 적용본)

``` 
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Simplified group functions - reduced database lookups
    function isGroupMember(groupId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/groups/$(groupId)/members/$(request.auth.uid));
    }
    
    function isGroupOwner(groupId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/groups/$(groupId)) &&
        request.auth.uid == resource.data.ownerId;
    }
    
    // Simplified rules for better performance - removed catch-all rule
    
    // 사용자 프로필 컬렉션 보안 규칙
    match /users/{userId} {
      allow read: if isOwner(userId) || 
        (isAuthenticated() && resource.data.privacy.showTaskActivity == true);
      allow write: if isOwner(userId);
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // 사용자 설정 서브컬렉션
    match /users/{userId}/settings/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // 그룹 컬렉션 보안 규칙
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.ownerId;
      allow update: if isAuthenticated() && 
        (isGroupOwner(groupId) || 
         (isGroupMember(groupId) && 
          resource.data.settings.allowMembersToInvite == true));
      allow delete: if isAuthenticated() && isGroupOwner(groupId);
      
      // 그룹 멤버 서브컬렉션
      match /members/{memberId} {
        allow read: if isGroupMember(groupId);
        allow write: if isGroupOwner(groupId);
      }
      
      // 그룹 채팅 서브컬렉션
      match /chat/{messageId} {
        allow read: if isGroupMember(groupId);
        allow create: if isGroupMember(groupId) && 
          request.auth.uid == request.resource.data.userId;
        allow update, delete: if isGroupMember(groupId) && 
          request.auth.uid == resource.data.userId;
      }
    }
    
    // 할일(Task) 컬렉션 보안 규칙
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == resource.data.assigneeId ||
         (resource.data.taskType == 'group' && resource.data.groupId != null && isGroupMember(resource.data.groupId)));
      
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        ((request.resource.data.taskType == 'personal') ||
         (request.resource.data.taskType == 'group' && request.resource.data.groupId != null && isGroupMember(request.resource.data.groupId)));
      
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == resource.data.assigneeId ||
         (resource.data.taskType == 'group' && resource.data.groupId != null && isGroupMember(resource.data.groupId) && 
          resource.data.groupId == request.resource.data.groupId));
      
      allow delete: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId ||
         (resource.data.taskType == 'group' && resource.data.groupId != null && isGroupOwner(resource.data.groupId)));
      
      // Simplified comments - inherit task permissions
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
          request.auth.uid == request.resource.data.userId;
        allow update, delete: if isAuthenticated() && 
          request.auth.uid == resource.data.userId;
      }
    }
    
    // 알림 컬렉션 보안 규칙
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) && 
        request.resource.data.read != resource.data.read; // Only allow marking as read
      allow delete: if isOwner(resource.data.userId);
    }
    
    // 활동 로그 컬렉션 보안 규칙 (읽기 전용)
    match /activities/{activityId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId ||
         isGroupMember(resource.data.groupId));
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId;
      allow update, delete: if false; // 수정/삭제 불가
    }
    
    // 통계 컬렉션 보안 규칙
    match /statistics/{userId} {
      allow read: if isOwner(userId) || 
        (isAuthenticated() && resource.data.public == true);
      allow write: if isOwner(userId);
    }
    
    // 그룹 초대 컬렉션
    match /invites/{inviteId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.invitedBy ||
         request.auth.email == resource.data.invitedEmail);
      allow create: if isAuthenticated() && 
        isGroupMember(request.resource.data.groupId);
      allow update: if isAuthenticated() && 
        request.auth.email == resource.data.invitedEmail &&
        request.resource.data.status != resource.data.status; // Only status change
      allow delete: if isGroupOwner(resource.data.groupId);
    }
    
    // 포인트 내역 컬렉션 보안 규칙
    match /pointHistory/{historyId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         isGroupMember(resource.data.groupId));
      allow create: if isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid || 
         isGroupOwner(request.resource.data.groupId));
      allow update, delete: if isAuthenticated() && 
        isGroupOwner(resource.data.groupId);
    }
    
    // 포인트 규칙 컬렉션 보안 규칙
    match /pointRules/{ruleId} {
      allow read: if isAuthenticated() && 
        isGroupMember(resource.data.groupId);
      allow create, update, delete: if isAuthenticated() && 
        isGroupOwner(resource.data.groupId);
    }
    
    // 포인트 통계 컬렉션 보안 규칙
    match /pointStats/{statsId} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         isGroupMember(resource.data.groupId));
      allow create, update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         isGroupOwner(resource.data.groupId));
    }
    
    // 기본 거부 규칙
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### 13.3 인덱스 및 에뮬레이터 구동
- 인덱스 정의는 `firestore.indexes.json`에 포함. 배포 명령: `firebase deploy --only firestore:indexes`
- 에뮬레이터 포트: UI 4000, Auth 9099, Firestore 8080, Storage 9199, Functions 5001

``` 
1:57:/workspace/firebase.json
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "functions": {
    "predeploy": [
      "npm --prefix \"$RESOURCE_DIR\" run build"
    ],
    "source": "functions",
    "runtime": "nodejs20"
  },
  "storage": {
    "rules": "storage.rules"
  },
  "hosting": {
    "headers": [
      {
        "source": "**",
        "headers": [
          {
            "key": "Access-Control-Allow-Origin",
            "value": "*"
          },
          {
            "key": "Access-Control-Allow-Methods",
            "value": "GET, POST, PUT, DELETE, OPTIONS"
          },
          {
            "key": "Access-Control-Allow-Headers",
            "value": "Content-Type, Authorization"
          }
        ]
      }
    ]
  },
  "emulators": {
    "auth": {
      "port": 9099
    },
    "functions": {
      "port": 5001
    },
    "firestore": {
      "port": 8080
    },
    "storage": {
      "port": 9199
    },
    "ui": {
      "enabled": true,
      "port": 4000
    },
    "singleProjectMode": true
  }
}
```

---

## 14. Firebase Storage 설계 및 보안 규칙

### 14.1 경로 표준
- 사용자 아바타: `users/{userId}/profile/{fileName}`
- 태스크 파일: `tasks/{taskId}/files/{fileName}`
- 태스크 댓글 파일: `tasks/{taskId}/comments/{commentId}/files/{fileName}`
- 채팅 첨부파일: `groups/{groupId}/chat/{userId}/{fileName}`
- 임시 업로드: `temp/{userId}/{fileName}`
- 시스템 파일: `system/{fileName}` (읽기 전용)

### 14.2 Storage 보안 규칙 (실제 적용본)

``` 
1:124:/workspace/storage.rules
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions for storage security
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isValidFileSize(maxSizeInMB) {
      return request.resource size < maxSizeInMB * 1024 * 1024;
    }
    
    function isValidFileName() {
      return request.resource.name.size() < 100; // File name length limit
    }
    
    function isValidFileType() {
      return request.resource.contentType.matches('image/.*|application/pdf|text/.*|application/msword|application/vnd.openxmlformats-officedocument.*|application/vnd.ms-excel|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    }
    
    // User profile images
    match /users/{userId}/profile/{fileName} {
      allow read: if true; // Profile images are public
      allow write: if isOwner(userId) && 
        isValidImageType() && 
        isValidFileName() &&
        request.resource.size > 0; // 파일 크기가 0보다 크기만 확인
      allow delete: if isOwner(userId);
    }
    
    // Task files - accessible by task members
    match /tasks/{taskId}/files/{fileName} {
      allow read: if isAuthenticated(); // Authenticated users can read
      allow write: if isAuthenticated() && 
        isValidFileSize(10) && // 10MB limit for task files
        isValidFileName() &&
        isValidFileType();
      allow delete: if isAuthenticated(); // Task owner or group admin should handle via app logic
    }
    
    // Task comment files - accessible by task members
    match /tasks/{taskId}/comments/{commentId}/files/{fileName} {
      allow read: if isAuthenticated(); // Authenticated users can read
      allow write: if isAuthenticated() && 
        isValidFileSize(10) && // 10MB limit for comment files
        isValidFileName() &&
        isValidFileType();
      allow delete: if isAuthenticated(); // Comment owner should handle via app logic
    }
    
    // Task attachments - accessible by task members
    match /tasks/{taskId}/attachments/{fileName} {
      allow read: if isAuthenticated(); // Authenticated users can read
      allow write: if isAuthenticated() && 
        isValidFileSize(10) && // 10MB limit for task attachments
        isValidFileName() &&
        request.resource.contentType.matches('image/.*|application/pdf|text/.*|application/msword|application/vnd.openxmlformats-officedocument.*');
      allow delete: if isAuthenticated(); // Task owner or group admin should handle via app logic
    }
    
    // Task attachments (new path) - accessible by task members
    match /task-attachments/{fileName} {
      allow read: if isAuthenticated(); // Authenticated users can read
      allow write: if isAuthenticated() && 
        isValidFileSize(10) && // 10MB limit for task attachments
        isValidFileName() &&
        request.resource.contentType.matches('image/.*|application/pdf|text/.*|application/msword|application/vnd.openxmlformats-officedocument.*|application/vnd.ms-excel|application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
      allow delete: if isAuthenticated(); // Task owner or group admin should handle via app logic
    }
    
    // Group shared files
    match /groups/{groupId}/files/{fileName} {
      allow read: if isAuthenticated(); // Group members only (verified via app)
      allow write: if isAuthenticated() && 
        isValidFileSize(100) && // 100MB limit for group files
        isValidFileName();
      allow delete: if isAuthenticated(); // Group admin should handle via app logic
    }
    
    // Group chat attachments
    match /groups/{groupId}/chat/{userId}/{fileName} {
      allow read: if isAuthenticated(); // Group members can read chat attachments
      allow write: if isAuthenticated() && 
        isValidFileSize(100) && // 100MB limit for chat attachments
        isValidFileName() &&
        isValidFileType();
      allow delete: if isAuthenticated(); // Chat message owner should handle via app logic
    }
    
    // Temporary uploads (for processing)
    match /temp/{userId}/{fileName} {
      allow read, write: if isOwner(userId) && 
        isValidFileSize(50) && // 50MB limit for temporary files
        isValidFileName();
      allow delete: if isOwner(userId);
    }
    
    // System files (app icons, etc.) - read only
    match /system/{fileName} {
      allow read: if true;
      allow write: if false; // Only admin can upload system files
    }
    
    // Backup files (admin only)
    match /backups/{fileName} {
      allow read, write: if false; // Only server can access backups
    }
    
    // Default deny all other paths
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
```

### 14.3 CORS 설정
- Firebase Hosting 헤더에 기본 CORS 허용이 포함되어 있습니다. 필요 시 `npm run firebase:setup-cors` 사용

---

## 15. Vercel 배포 및 환경 변수

### 15.1 프로젝트 설정
- 프로젝트명: `moonwave-plan`
- 빌드 명령: `npm run build:vercel` (Vite 빌드)
- 출력 디렉토리: `dist`
- SPA 라우팅: 모든 경로 `index.html`로 rewrite

### 15.2 vercel.json (실제 적용본)

``` 
1:119:/workspace/vercel.json
{
  "version": 2,
  "name": "moonwave-plan",
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    }
  ],
  "buildCommand": "npm run build:vercel",
  "routes": [
    {
      "handle": "filesystem"
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        }
      ]
    },
    {
      "source": "/assets/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    },
    {
      "source": "/firebase-messaging-sw.js",
      "headers": [
        {
          "key": "Content-Type",
          "value": "application/javascript"
        },
        {
          "key": "Service-Worker-Allowed",
          "value": "/"
        },
        {
          "key": "Cache-Control",
          "value": "no-cache, no-store, must-revalidate"
        }
      ]
    },
    {
      "source": "/manifest.json",
      "headers": [
        {
          "key": "Content-Type",
          "value": "application/manifest+json"
        },
        {
          "key": "Cache-Control",
          "value": "public, max-age=3600"
        }
      ]
    }
  ],
  "env": {
    "VITE_APP_NAME": "@VITE_APP_NAME",
    "VITE_APP_VERSION": "@VITE_APP_VERSION",
    "VITE_APP_URL": "@VITE_APP_URL",
    "VITE_FIREBASE_API_KEY": "@VITE_FIREBASE_API_KEY",
    "VITE_FIREBASE_AUTH_DOMAIN": "@VITE_FIREBASE_AUTH_DOMAIN",
    "VITE_FIREBASE_PROJECT_ID": "@VITE_FIREBASE_PROJECT_ID",
    "VITE_FIREBASE_STORAGE_BUCKET": "@VITE_FIREBASE_STORAGE_BUCKET",
    "VITE_FIREBASE_MESSAGING_SENDER_ID": "@VITE_FIREBASE_MESSAGING_SENDER_ID",
    "VITE_FIREBASE_APP_ID": "@VITE_FIREBASE_APP_ID",
    "VITE_FIREBASE_MEASUREMENT_ID": "@VITE_FIREBASE_MEASUREMENT_ID",
    "VITE_FCM_VAPID_KEY": "@VITE_FCM_VAPID_KEY",
    "VITE_ENABLE_PWA": "@VITE_ENABLE_PWA",
    "VITE_ENABLE_NOTIFICATIONS": "@VITE_ENABLE_NOTIFICATIONS",
    "VITE_ENABLE_CLAUDE_AI": "@VITE_ENABLE_CLAUDE_AI",
    "VITE_CLAUDE_API_KEY": "@VITE_CLAUDE_API_KEY",
    "CLAUDE_API_KEY": "@CLAUDE_API_KEY",
    "VITE_CLAUDE_MODEL": "@VITE_CLAUDE_MODEL",
    "VITE_CLAUDE_MAX_TOKENS": "@VITE_CLAUDE_MAX_TOKENS",
    "VITE_CLAUDE_TASK_ASSISTANT": "@VITE_CLAUDE_TASK_ASSISTANT",
    "VITE_CLAUDE_SMART_SUGGESTIONS": "@VITE_CLAUDE_SMART_SUGGESTIONS",
    "VITE_CLAUDE_AUTO_CATEGORIZE": "@VITE_CLAUDE_AUTO_CATEGORIZE",
    "VITE_NODE_ENV": "@VITE_NODE_ENV",
    "VITE_DEBUG": "@VITE_DEBUG",
    "VITE_API_BASE_URL": "@VITE_API_BASE_URL",
    "VITE_ENABLE_ANALYTICS": "@VITE_ENABLE_ANALYTICS",
    "VITE_GOOGLE_ANALYTICS_ID": "@VITE_GOOGLE_ANALYTICS_ID",
    "VITE_SENTRY_DSN": "@VITE_SENTRY_DSN"
  },
  "functions": {
    "src/pages/api/**/*.ts": {
      "runtime": "nodejs20.x"
    }
  }
}
```

### 15.3 환경변수 일람 및 의미
- VITE_APP_NAME, VITE_APP_VERSION, VITE_APP_URL: 앱 메타 정보
- VITE_FIREBASE_*: Firebase 웹 앱 구성
- VITE_FCM_VAPID_KEY: 웹 푸시 키
- VITE_ENABLE_PWA, VITE_ENABLE_NOTIFICATIONS, VITE_ENABLE_ANALYTICS: 기능 플래그
- VITE_CLAUDE_*, CLAUDE_API_KEY: Claude AI 통합 설정(선택)
- VITE_API_BASE_URL: 외부 API 연동 시 사용
- VITE_SENTRY_DSN, VITE_GOOGLE_ANALYTICS_ID: 모니터링/분석

### 15.4 배포 절차 (Vercel 대시보드)
1. 프로젝트 연결 (GitHub `hersouls/Plan_v2.0`)
2. Environment Variables에 위 변수 추가
3. 빌드 명령 `npm run build:vercel`, Output `dist` 확인
4. 배포 후 SPA 라우팅 동작 확인

### 15.5 CLI/CI 배포 (GitHub Actions)
- 미리 Settings > Secrets and variables > Actions에 다음 시크릿 설정:
  - VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID
- PR 시 Preview 배포, main/master 머지 시 Production 배포

---

## 16. 도메인 유지 가이드 (plan.mooonwave.kr)

### 16.1 연결 방식
- Vercel의 Domains 메뉴에서 `plan.mooonwave.kr` 추가
- DNS가 외부 레지스트라에 있을 경우, Vercel가 안내하는 A/CNAME 레코드로 설정
- SSL/TLS는 Vercel에서 자동 관리 (Let’s Encrypt)

### 16.2 점검 체크리스트
- 인증서 유효성 확인 (HTTPS 강제 적용)
- `www` 서브도메인 리다이렉트 필요 여부 검토
- 캐시 무효화: 변경 후 새 배포 링크 확인

---

## 17. CI/CD 파이프라인 (GitHub Actions)

### 17.1 워크플로 개요: `.github/workflows/ci.yml`
- 단계: test → build → (e2e 선택) → security → deploy-preview (PR) / deploy-production (main/master)
- Node 20, `npm ci` 사용, 품질 검사(quality:check), 타입 체크, 빌드 수행
- Vercel Action으로 Preview/Production 배포, `--yes --confirm`로 비대화형 설정

```yaml
# 본문 시작
name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# ✅ 브랜치별 단일 실행(중복 배포 방지)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # (권장) 커버리지/버전 태깅 등에 유용

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run quality checks
        run: npm run quality:check

      - name: Run tests with coverage
        run: npm run test:ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ✅ 빌드 타임 env 필요시 여기서 주입
      - name: Build application
        run: npm run build:production
        env:
          CI: true
          NODE_ENV: production
          # 예) VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          # 예) FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}

      # (선택) 산출물 업로드 - Vercel이 재빌드 할 거라면 굳이 필요 없음
      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: build-files
      #     path: dist/
      #     retention-days: 7

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    if: false  # Playwright not installed, skip for now
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      # ✅ (필요시) 미리보기 서버 기동 + 대기
      # playwright.config에 webServer가 없다면 아래 두 스텝을 활성화
      # - name: Start preview server
      #   run: npx vite preview --port 4173 --strictPort --host &
      # - name: Wait for server
      #   run: npx wait-on http://localhost:4173

      - name: Run E2E tests
        run: npm run test:e2e
        # env:
        #   BASE_URL: http://localhost:4173

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ✅ 파이프라인 차단을 원치 않으면 아래 중 택1
      - name: Run security audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run custom security checks
        run: npm run security:check
        continue-on-error: true

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Preview)
        uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--yes --confirm'

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel (Production)
        uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: '--prod --yes --confirm'
```

### 17.2 필요 시크릿
- VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID

---

## 18. 로컬 개발 환경

### 18.1 기본 명령 (package.json)
- 개발 서버: `npm run dev`
- 깨끗한 개발 시작: `npm run dev:fresh`
- 프로덕션 빌드: `npm run build:production`
- 정적 프리뷰: `npm run preview`

### 18.2 Firebase 에뮬레이터
- 에뮬레이터 실행 시 포트 충돌 방지: `npm run dev:clean`
- Firestore/Rules/Indexes/Storage와 Functions를 함께 테스트

### 18.3 기타 유틸리티 스크립트
- 보안 점검: `npm run security:check`
- PWA 점검: `npm run pwa:check`
- Functions 배포 유틸: `npm run functions:deploy`

---

## 19. 프론트엔드 라우팅 및 상태

### 19.1 라우팅 (React Router)
- 보호 라우트: `/`, `/todo`, `/tasks/*`, `/family`, `/points`, `/statistics`, `/settings`, `/notifications`
- 공개 라우트: `/login`, `/about`, `/terms-of-service`, `/project-detail/:projectId`
- SPA 라우팅은 Vercel에서 모든 경로를 `index.html`로 rewrite

### 19.2 Firebase 클라이언트 초기화
- 설정 파일: `src/lib/firebase.ts`
- 환경변수 미설정 시 안전한 기본값으로 폴백 (개발 편의)

```ts
// 발췌: Firebase 웹 앱 구성 (환경변수 기반)
const config = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
};
```

### 19.3 스토리지 사용 규칙
- 아바타 업로드는 본인만 가능, 공개 읽기
- 채팅/태스크 첨부는 인증 사용자만 업로드 가능(용량/확장자 제한 적용)

---

## 20. 배포 체크리스트 (요약)
1. Firebase 프로젝트/환경변수 준비 (웹 앱 구성, FCM VAPID)
2. Firestore 규칙/인덱스/Storage 규칙 반영: `npm run firebase:deploy`
3. Vercel 환경변수 설정 및 빌드/배포
4. 도메인 연결 및 HTTPS 확인 (`plan.mooonwave.kr`)
5. 기능 플래그 및 분석/모니터링 설정값 확인
6. 알림(FCM), PWA, 라우팅 동작 점검
